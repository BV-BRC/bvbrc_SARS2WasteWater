### Define wildcards ###
zpd_samples = glob_wildcards("staging/pe_reads/{sample}_R{read_num}.fastq.gz").sample
zpd_read_nums = glob_wildcards("staging/pe_reads/{sample}_R{read_num}.fastq.gz").read_num

unzpd_samples = glob_wildcards("staging/pe_reads/{sample}_R{read_num}.fastq").sample
unzpd_read_nums = glob_wildcards("staging/pe_reads/{sample}_R{read_num}.fastq").read_num
samples = zpd_samples + unzpd_samples
read_nums = zpd_read_nums + unzpd_read_nums

### Define functions for global handelers: Onstart, onsuccess and onerror ###
# Define the onstart handler
def onstart(samples):
    print(f"Starting workflow for {wildcards}")
# Define the onsuccess handler
def onsuccess(samples):
    print(f"Workflow completed successfully for {wildcards}")

# Define the onerror handler
def onerror(wildcards, input, output, error):
    msg = f"Error occurred for {wildcards} \n \
    Input: {input} \n \
    Output: {output} \n \
    Error: {error}"
    with open("JobFailed.txt", "w") as failed_samples:
        print(msg)
    pass

#### Define global handlers ####
onstart: onstart
onsuccess: onsuccess
onerror: onerror

### Get variables from config ###
if os.path.isfile("config.json") == True:
    pass
else:
    msg = f"Unable to locate config.json"
    sys.stderr.write(msg)
    sys.exit(1)
    pass

configfile: "config.json"
primer = config["params"]["primers"]
primer_ver = config["params"]["primer_version"]

msg = "snakefile command recieved - FREYJA PAIRED END FASTQ PROCESSING \n"
sys.stderr.write(msg)

# Define base rule all
rule_all_list = [
    expand("output/{sample}/fastqc_results/{sample}.ivar_fastqc.html", sample = samples)
    ]

### Add zpd samples to rule all list ###
if len(zpd_samples) >= 2:
    rule_all_list.append(expand("output/{zpd_sample}/assembly/{zpd_sample}.ivar.bam", zpd_sample = zpd_samples))
    rule_all_list.append(expand("output/{zpd_sample}/fastqc_results/{zpd_sample}_R{zpd_read_num}_fastqc.html", zpd_sample = zpd_samples, zpd_read_num = zpd_read_nums))
else:
    msg = "no zpd single end samples"
    sys.stderr.write(msg)

### Add unzpd samples to rule all list ###
if len(unzpd_samples) >= 2:
    rule_all_list.append(expand("output/{unzpd_sample}/assembly/{unzpd_sample}.ivar.bam", unzpd_sample = unzpd_samples))
    rule_all_list.append(expand("output/{unzpd_sample}/fastqc_results/{unzpd_sample}_R{unzpd_read_num}_fastqc.html", unzpd_sample = unzpd_samples, unzpd_read_num = unzpd_read_nums))
else:
    msg = "no unzpd single end samples"
    sys.stderr.write(msg)

rule all:
    input:
        rule_all_list

rule zpd_assembly:
    input:
        read1 = "staging/pe_reads/{zpd_sample}_R1.fastq.gz",
        read2 = "staging/pe_reads/{zpd_sample}_R2.fastq.gz",
    params:
        output_base = "{zpd_sample}",
        output_dir = "output/{zpd_sample}/assembly",
        primer_type = primer,
        primer_version = primer_ver
    output:
        ivar_bam = "output/{zpd_sample}/assembly/{zpd_sample}.ivar.bam",
        ivar_sorted_bam = "output/{zpd_sample}/assembly/{zpd_sample}.sorted.bam"
    shell:
        """
        mkdir -p {params.output_dir}

        sars2-onecodex -k -j 12 -D 3 -d 8000 \
            --primer-version {params.primer_version} \
            --primers {params.primer_type} \
            -n {wildcards.zpd_sample} \
            -1 {input.read1} \
            -2 {input.read2} \
            {params.output_base} \
            {params.output_dir}
        """

rule unzpd_assembly:
    input:
        read1 = "staging/pe_reads/{unzpd_sample}_R1.fastq",
        read2 = "staging/pe_reads/{unzpd_sample}_R2.fastq",
    params:
        output_base = "{unzpd_sample}",
        output_dir = "output/{unzpd_sample}/assembly",
        primer_type = primer,
        primer_version = primer_ver
    output:
        ivar_bam = "output/{unzpd_sample}/assembly/{unzpd_sample}.ivar.bam",
        ivar_sorted_bam = "output/{unzpd_sample}/assembly/{unzpd_sample}.sorted.bam"
    shell:
        """
        mkdir -p {params.output_dir}

        sars2-onecodex -k -j 12 -D 3 -d 8000 \
            --primer-version {params.primer_version} \
            --primers {params.primer_type} \
            -n {wildcards.unzpd_sample} \
            -1 {input.read1} \
            -2 {input.read2} \
            {params.output_base} \
            {params.output_dir}
        """

rule fastqc_zpd_reads:
    input:
        raw_read = "staging/pe_reads/{zpd_sample}_R{unzpd_read_num}.fastq.gz",
    params:
        fastqc_dir = directory("output/{zpd_sample}/fastqc_results"),
        clean_up = directory("clean_up"),
        fastqc_zip = "output/{zpd_sample}/fastqc_results/{zpd_sample}_R{unzpd_read_num}_fastqc.zip"
    output:
        fastqc_html = "output/{zpd_sample}/fastqc_results/{zpd_sample}_R{unzpd_read_num}_fastqc.html",
        fastqc_zip = "clean_up/{zpd_sample}_R{unzpd_read_num}_fastqc.zip"
    shell:
        """
        mkdir -p {params.fastqc_dir}
        mkdir -p {params.clean_up}

        /opt/patric-common/runtime/bin/fastqc --version

        /opt/patric-common/runtime/bin/fastqc {input.raw_read} \
        -o {params.fastqc_dir} -q

        mv {params.fastqc_zip} {output.fastqc_zip}
        """

rule fastqc_unzpd_reads:
    input:
        raw_read = "staging/pe_reads/{unzpd_sample}_R{unzpd_read_num}.fastq",
    params:
        fastqc_dir = directory("output/{unzpd_sample}/fastqc_results"),
        clean_up = directory("clean_up"),
        fastqc_zip = "output/{unzpd_sample}/fastqc_results/{unzpd_sample}_R{unzpd_read_num}_fastqc.zip"
    output:
        fastqc_html = "output/{unzpd_sample}/fastqc_results/{unzpd_sample}_R{unzpd_read_num}_fastqc.html",
        fastqc_zip = "clean_up/{unzpd_sample}_R{unzpd_read_num}_fastqc.zip"
    shell:
        """
        mkdir -p {params.fastqc_dir}
        mkdir -p {params.clean_up}

        /opt/patric-common/runtime/bin/fastqc --version

        /opt/patric-common/runtime/bin/fastqc {input.raw_read} \
        -o {params.fastqc_dir} -q

        mv {params.fastqc_zip} {output.fastqc_zip}
        """

rule fastqc_ivar:
    input:
        ivar_bam = "output/{sample}/assembly/{sample}.ivar.bam",
        ivar_sorted_bam = "output/{sample}/assembly/{sample}.sorted.bam"
    params:
        fastqc_dir = "output/{sample}/fastqc_results",
        clean_up = "clean_up",
        ivar_zip = "output/{sample}/fastqc_results/{sample}.ivar_fastqc.zip",
        ivar_sorted_zip = "output/{sample}/fastqc_results/{sample}.sorted_fastqc.zip"
    output:
        ivar_html = "output/{sample}/fastqc_results/{sample}.ivar_fastqc.html",
        ivar_sorted_html = "output/{sample}/fastqc_results/{sample}.sorted_fastqc.html",
        ivar_zip = "clean_up/{sample}.ivar_fastqc.zip",
        ivar_sorted_zip = "clean_up/{sample}.sorted_fastqc.zip",
    shell:
        """
        mkdir -p {params.fastqc_dir}
        mkdir -p {params.clean_up}

        /opt/patric-common/runtime/bin/fastqc --version

        /opt/patric-common/runtime/bin/fastqc {input.ivar_bam} \
        -o {params.fastqc_dir} -q

        mv {params.ivar_zip} {output.ivar_zip}

        /opt/patric-common/runtime/bin/fastqc {input.ivar_sorted_bam} \
        -o {params.fastqc_dir} -q

        mv {params.ivar_sorted_zip} {output.ivar_sorted_zip}
        """
